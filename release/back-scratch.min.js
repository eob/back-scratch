/**
* Back Scratch Client
 *
 * @author Ted Benson
 * @copyright Edward Benson 2013
 * All Rights Reserved
 */

(function(){var e=this,t;typeof exports!="undefined"?t=exports:t=e.CTSUI={},t.VERSION="0.1.0",t.$=e.jQuery;var n=e._;!n&&typeof require!="undefined"&&(n=require("underscore"));var r=/\s+/,i=function(e,t,n,i){if(!n)return!0;if(typeof n=="object")for(var s in n)e[t].apply(e,[s,n[s]].concat(i));else{if(!r.test(n))return!0;var o=n.split(r);for(var u=0,a=o.length;u<a;u++)e[t].apply(e,[o[u]].concat(i))}},s=function(e,t,n){var r,i=-1,s=t.length;switch(n.length){case 0:while(++i<s)(r=t[i]).callback.call(r.ctx);return;case 1:while(++i<s)(r=t[i]).callback.call(r.ctx,n[0]);return;case 2:while(++i<s)(r=t[i]).callback.call(r.ctx,n[0],n[1]);return;case 3:while(++i<s)(r=t[i]).callback.call(r.ctx,n[0],n[1],n[2]);return;default:while(++i<s)(r=t[i]).callback.apply(r.ctx,n)}},o=t.Events={on:function(e,t,n){if(!i(this,"on",e,[t,n])||!t)return this;typeof this._events=="undefined"&&(this._events={});var r=this._events[e]||(this._events[e]=[]);return r.push({callback:t,context:n,ctx:n||this}),this},once:function(e,t,r){if(!i(this,"once",e,[t,r])||!t)return this;var s=this,o=n.once(function(){s.off(e,o),t.apply(this,arguments)});return o._callback=t,this.on(e,o,r),this},off:function(e,t,r){var s,o,u,a,f,l,c,h;if(!this._events||!i(this,"off",e,[t,r]))return this;if(!e&&!t&&!r)return this._events={},this;a=e?[e]:n.keys(this._events);for(f=0,l=a.length;f<l;f++){e=a[f];if(typeof this._events[e]!="undefined"){s=this._events[e],u=[];if(t||r)for(c=0,h=s.length;c<h;c++)o=s[c],(t&&t!==(o.callback._callback||o.callback)||r&&r!==o.context)&&u.push(o);this._events[e]=u}}return this},trigger:function(e){if(!this._events)return this;var t=[];arguments.length>1&&(t=arguments.slice(1,arguments.length));if(!i(this,"trigger",e,t))return this;var n=this._events[e],r=this._events.all;return n&&s(this,n,t),r&&s(this,r,arguments),this},listenTo:function(e,t,r,i){i=i||this;var s=this._listeners||(this._listeners={}),o=e._listenerId||(e._listenerId=n.uniqueId("l"));return s[o]=e,e.on(t,r||i,i),this},stopListening:function(e,t,n,r){r=r||this;var i=this._listeners;if(!i)return;if(e)e.off(t,n,r),!t&&!n&&delete i[e._listenerId];else{for(var s in i)i[s].off(null,null,r);this._listeners={}}return this}};o.bind=o.on,o.unbind=o.off;var u=t.StateMachine={fsmInitialize:function(e,t,r){this._fsmCurrent=e,this._fsmArcs={},n.each(t,function(e){n.contains(this._fsmArcs,e.from)||(this._fsmArcs[e.from]={}),this._fsmArcs[e.from][e.to]=e.name},this)},fsmCurrentState:function(){return this._fsmCurrent},fsmCanTransition:function(e){return this._fsmArcs[this._fsmCurrent]&&this._fsmArcs[this._fsmCurrent][e]?!0:!1},fsmTransition:function(e){if(!this.fsmCanTransition)throw new Error("Can not make transition "+this._fsmCurrent+" -> "+e);var t=this._fsmCurrent,n=e,r=this._fsmArcs[t][n];this.trigger("FsmLeft:"+t),this._fsmCurrent=n,console.log("Transitioning to",n),this.trigger("FsmEdge:"+r),this.trigger("FsmEntered:"+n)}},a=t.Presence=function(e,t){this.opts=e||{server:"http://localhost:3000",path:"/api/v1"},this.token=null,this.initialize.apply(this,t)};n.extend(a.prototype,o,{initialize:function(e){},login:function(e){var n=this.opts.server+this.opts.path+"/user/login";t.$.ajax({type:"POST",dataType:"json",url:n,crossDomain:!0,success:this._loginAsAnonymousSucceeded,error:this._loginAsAnonymousFailed,context:this})},logout:function(e){t.$.ajax({dataType:"json",type:"POST",url:this.opts.server+this.opts.path+"/user/logout",success:e,headers:{"X-CSRF-Token":this.token},crossDomain:!0,beforeSend:function(e){e.withCredentials=!0}})},request:function(e){this.token!==null&&(typeof e.data=="undefined"&&(e.data={}),e.data.auth_token=this.token),t.$.ajax(e)},isLoggedInAnonymously:function(){return!1},isLoggedIn:function(e){this.request({dataType:"json",url:this.opts.server+this.opts.path+"/user/is_logged_in?callback=?",success:n.bind(function(t){this.token=t.token,e(t)},this)})},signup:function(){},_loginAsAnonymousFailed:function(e,t,n){this.trigger("LoginAsAnonymousFailed"),callback()},_loginAsAnonymousSucceeded:function(e){this.token=e.token,this.trigger("LoginAsAnonymousSucceeded")},_loginFailed:function(){this.trigger("LoginFailed")},_loginSucceeded:function(){this.trigger("LoginSucceeded")},_logoutFailed:function(){this.trigger("LogoutFailed")},_logoutSucceeded:function(){this.trigger("LogoutSucceeded")},_signupFailed:function(){this.trigger("SignupFailed")},_signupSucceeded:function(){this.trigger("SignupSucceeded")}});var f=t.Reporting=function(e,t,n){this.opts=t||{},this.pesence=e,this.initialize.apply(this,n),this.queue=[]};n.extend(f.prototype,{report:function(e,t){var n={},r=new Date;n.name=e,n.params=t,n.localTime=r.getTime(),n.localTimeZoneOffset=r.getTimezoneOffset(),this.queue[this.queue.length]=n,this.maybeFlushQueue()},maybeFlushQueue:function(){this.flushQueue()},flushQueue:function(){t.$.ajax({dataType:"json",type:"POST",url:this.opts.server+this.opts.path+"/report",success:callback,headers:{"X-CSRF-Token":this.token},crossDomain:!0,beforeSend:function(e){e.withCredentials=!0}})},_flushQueueSuccess:function(e){},_flushQueueFailed:function(e){}});var l=t.WidgetView=function(e,t){};n.extend(l.prototype,{});var c=t.WidgetController=function(e,t){this.opts=e||{},this.initialize.apply(this,t),this.desiredFutureState=null};n.extend(c.prototype,o,u,{initialize:function(e){this.initializeStateMachine(),this.reporting=new t.Reporting,this.presence=new t.Presence,this.view=new t.WidgetView,this.presence.on("LoginSucceeded",this._loginSuccess,this),this.presence.on("LoginFailed",this._loginFailure,this)},initializeStateMachine:function(){this.fsmInitialize("Loaded",[{from:"Loaded",to:"Idle",name:"Startup"},{from:"Idle",to:"Copying",name:"Copying"},{from:"Idle",to:"Pasting",name:"Pasting"},{from:"Copying",to:"Idle",name:"DoneCopying"},{from:"Pasting",to:"Idle",name:"DonePasting"}])},_loginSuccess:function(){},_loginFailure:function(){}})}).call(this);